## 5. 互联网层 - 转发

### 5.1 介绍

本节介绍了报文转发的过程。

### 5.2 转发演练

IP中没有单独的转发功能规范。 相反，转发由互联网层协议（[INTERNET:1]、[INTERNET:2]、[INTERNET:3]、[INTERNET:8] 和 [ROUTE:11]）的协议规范涵盖。

#### 5.2.1 转发算法

​	由于主要协议文档都没有详细描述转发算法，因此我们在这里介绍它。 这只是一个总体概述，省略了重要的细节，例如拥塞的处理，这些细节将在后面的部分中讨论。 不要求实现完全遵循[5.2.1.1]、[5.2.1.2]和[5.2.1.3]节中给出的算法。 编写路由器软件的大部分挑战是**最大化路由器转发数据包的速率**，同时仍然实现相同的算法效果。 有关如何执行此操作的详细信息超出了本文档的范围，部分原因是它们严重依赖于路由器的体系结构。 相反，我们只是指出步骤之间的顺序依赖性：

1. 在根据标头内容执行任何操作之前，路由器必须验证 IP header，如第 [5.2.2] 节所述。 这使得路由器能够在消耗其他资源之前检测并丢弃坏数据包。
2. 处理某些IP选项需要路由器将其IP地址插入到选项中。 如第 [5.2.4] 节所述，**插入的地址必须是发送数据包的逻辑接口的地址**，或者**如果数据包是通过未编号的接口发送的，则插入的地址必须是路由器的 router-id**。 因此，只有在选择输出接口之后才能完成这些选项的处理。
3. 由于第[4.2.2.9]节中提到的原因，路由器在检查数据包是否应传递到路由器本身之前无法检查并递减 TTL。
4. 更一般地，当数据包在本地传送到路由器时，不得以任何方式修改其 IP 标头（除非路由器可能需要将时间戳插入到 IP 标头中的任何时间戳选项中）。 因此，在路由器确定数据包是否要本地传送到路由器之前，它不能以任何不准备撤消的方式更新IP报头。

##### 5.2.1.1 General

本节介绍一般转发算法。 该算法适用于要转发的所有形式的数据包：**单播、多播和广播**。

1. 路由器从链路层接收 IP 数据包（以及有关它的附加信息，如第 [3.1] 节所述）。

2. 路由器验证 IP头，如第 [5.2.2] 节所述。 请注意，IP 重组不会完成，除了在步骤 (4) 中排队等待本地传送的 IP 片段之外。 

3. 路由器执行任何 IP 选项的大部分处理。 如第[5.2.4]节所述，一些IP选项在做出路由决定后需要额外的处理。 

4. 路由器检查IP数据报的目的IP地址，如第[5.2.3]节所述，以确定它应如何继续处理IP数据报。 存在三种可能性：

   - IP 数据报的目的地是路由器，并且应该排队等待本地传送，并在需要时进行重组。
   - IP 数据报不是发往路由器的，应排队等待转发。
   - IP 数据报应排队等待转发，但（副本）也必须排队等待本地传送。

   

##### 5.2.1.2 单播

由于 [INTRO:2] 很好地涵盖了本地传送情况，因此下面**【假设 IP 数据报已排队等待转发】**。

如果目标是 IP 单播地址：

5. 【转发器】通常通过在路由器的路由表中查找数据包的目的地来确定数据包的下一跳 IP 地址。 该过程在[5.2.4]节中有更详细的描述。 此过程还决定哪个网络接口应该用于发送数据包。
6. 【转发器】验证是否允许转发数据包。 源地址和目标地址应该是有效的，如第 [5.3.7] 节和第 [5.3.4] 节中所述。 如果路由器支持转发的管理约束，例如第 [5.3.9] 节中所述的那些约束，则这些约束必须是 使满意。
7. 【转发器】递减（至少 1）并检查数据包的 TTL，如第 [5.3.1] 节中所述。  
8. 【转发器】执行步骤 3 中无法完成的任何 IP 选项处理。
9. 【转发器】执行任何必要的 IP 分段，如第 [4.2.2.7] 节中所述。 由于此步骤发生在出接口选择（步骤5）之后，因此同一数据报的所有片段都将从同一接口发送出去。
10. 【转发器】确定数据包下一跳的链路层地址。 执行此操作的机制取决于链路层（请参阅第 3 章）。
11. 【转发器】将 IP 数据报（或其每个片段）封装在适当的链路层帧中，并将其排队以便在步骤 5 中选择的接口上输出。
12. 【转发器】在必要时发送 ICMP 重定向，如第 [ 4.3.3.2]中所述。。

##### 5.2.1.3 组播

如果目的地是 IP 多播，则执行以下步骤。 请注意，IP 单播转发和 IP 多播转发之间的主要区别是

- IP 组播通常根据数据报的源 IP 地址和目标 IP 地址进行转发
- IP 组播使用扩展环搜索
- IP 组播转发为 **链路级组播**，并且 ICMP 错误永远不会发送以响应 IP 多播数据报。

请注意，IP 多播转发仍处于实验阶段。 因此，下面提出的算法不是强制性的，并且仅作为示例提供。

(5a) 根据数据报报头中找到的 IP 源地址和目标地址，路由器确定是否已在正确的接口上接收到数据报并进行转发。 如果不是，则数据报将被静默丢弃。 确定正确接收接口的方法取决于所使用的多播路由算法。 在最简单的算法之一——反向路径转发（RPF）中，**正确的接口是用于将单播转发回数据报源的接口**。

(6a) 根据数据报报头中的 IP 源地址和目标地址，②路由器确定数据报的传出接口。 为了实现 IP 多播的扩展环搜索（参见[INTERNET:4]），为每个传出接口指定了最小 TTL 值。 通过在每个最小 TTL 值小于或等于数据报头中的 TTL 值的传出接口上单独应用剩余步骤，将多播数据报的副本转发出每个此类接口。

(7a) 路由器将数据包的 TTL 减 1。

(8a)转发器执行步骤(3)中无法完成的任何IP选项处理。 

 (9a) 转发器执行任何必要的 IP 分段，如第 [4.2.2.7] 节中所述。  

(10a) 转发器确定在链路层封装中使用的链路层地址。 执行此操作的机制取决于链路层。 在 LAN 上，选择链路级多播或广播作为数据报 IP 多播地址的算法转换。 有关更多详细信息，请参阅各种 IP-over-xxx 规范。 

 (11a) 转发器将数据包（或其每个片段）封装在适当的链路层帧中，并将其排队以便在适当的接口上输出。



#### 5.2.2 IP头验证

在路由器可以处理任何 IP 数据包之前，它必须对数据包的 IP 标头执行以下基本有效性检查，以确保标头有意义。 如果数据包未通过以下任何测试，则必须将其静默丢弃，并且应记录错误。

(1) 链路层报告的**packet length必须足够大以容纳最小长度的合法IP数据报（20字节）**。  

(2) IP checksum必须正确。 

(3) IP version必须为4。如果版本号不是4，则该数据包可能是另一个版本的IP，例如IPng或ST-II。  

(4) IP header长度字段必须足够大，以容纳最小长度的合法 IP 数据报（20 字节 = 5 个字）。 

(5) IP total length字段必须足够大以容纳IP数据报报头，其长度在IP header length字段中指定。

路由器不得有允许禁用任何这些测试的配置选项。 

如果数据包通过了第二次和第三次测试，IP头长度字段至少为4，并且IP total length字段和链路层报告的数据包长度都至少为16，那么，尽管有上述规则，路由器可以 响应ICMP参数问题消息，其指针指向IP头长度字段（如果第四次测试失败）或IP总长度字段（如果第五次测试失败）。 然而，它仍然必须丢弃数据包并且仍然应该记录错误。 

这些规则（以及整个文档）仅适用于互联网协议的第 4 版。 这些规则不应被解释为禁止路由器支持其他版本的 IP。 此外，如果路由器能够真正将数据包分类为 IP 的其他版本，那么它不应该将该数据包视为本备忘录上下文中的错误数据包。

**实现** 

为了错误报告的目的，需要确定报头无效的原因，尽管并不总是完全可能。 可能的原因有四个：

- 链路层截断了 IP 标头。
- 数据报使用的是标准 IP 版本（版本 4）以外的 IP 版本。
- IP 标头在传输过程中已损坏。
- 发送方生成了非法的 IP 标头。

​	可能需要按照列出的顺序执行检查，因为我们相信这种顺序最有可能正确地对错误原因进行分类。 出于错误报告的目的，还可能需要检查未通过这些测试的数据包是否具有指示 IPng 或 ST-II 的 IP 版本号； 这些应根据各自的规范进行处理。

此外，路由器应该验证链路层报告的数据包长度至少与数据包的 IP 标头中记录的 IP 总长度一样大。 如果数据包看起来已被截断，则必须丢弃该数据包，应记录错误，并且路由器应使用 ICMP 参数问题消息进行响应，该消息的指针指向 IP 总长度字段。



**讨论** 

​	由于任何涉及数据损坏的高层协议都会在数据包数据到达其最终目的地时检测到数据包数据的截断，因此路由器不一定需要执行上述建议的检查来维护协议的正确性。 然而，通过进行此检查，路由器可以大大简化确定路径中的哪一跳正在截断数据包的任务。 它还将减少路由器下游的资源消耗，因为下游系统不需要处理数据包。



最后，如果 IP 标头中的目标地址不是路由器的地址之一，则路由器应该验证数据包不包含严格源和记录路由选项。 如果数据包未通过此测试（如果它包含严格的源路由选项），则路由器应记录该错误，并应使用 ICMP 参数问题错误进行响应，其中指针指向有问题的数据包的 IP 目标地址。

**讨论** 

​	有些人可能建议路由器应该响应 Bad Source Route 消息而不是 Parameter Problem 消息。 然而，当数据包未通过此测试时，通常表明前一跳路由器存在协议错误，而错误源路由则表明源主机请求的网络路径不存在或已损坏。



#### 5.2.3 本地分发决定

当路由器接收到 IP 数据包时，它必须决定该数据包是【发送】至【路由器（并应在本地传送）】还是【发送】至【另一个系统（并应由转发器处理】）。 还有一种混合情况，其中某些 IP 广播和 IP 多播既在本地传送又转发。 路由器必须使用以下规则确定这三种情况中的哪一种适用。

- 未过期的源路由选项是指其指针值未指向源路由中最后一个条目的选项。 如果数据包包含未过期的源路由选项，则选项中的指针会前进，直到指针确实指向选项中的最后一个地址，或者下一个地址不是路由器自己的地址之一。 在后一种（正常）情况下，无论以下规则如何，都会转发数据包（而不是在本地传递）。
- 在以下情况下，数据包在本地传送，不考虑转发：
  -  数据包的目标地址与路由器的 IP 地址之一完全匹配
  - 数据包的目标地址是有限广播地址 ({-1, -1})，或者
  - 数据包的目的地是从不转发的 IP 多播地址（例如 224.0.0.1 或 224.0.0.2），并且（至少）与数据包到达的物理接口关联的逻辑接口之一是目的地的成员 多播组。
- 在以下情况下，数据包将传递到转发器并在本地传送：
  - 数据包的目标地址是一个 IP 广播地址，它至少寻址路由器的一个逻辑接口，但不寻址与数据包到达的物理接口关联的任何逻辑接口
  - 数据包的目的地是允许转发的 IP 多播地址（与 224.0.0.1 和 224.0.0.2 不同），并且（至少）与数据包到达的物理接口关联的逻辑接口之一是目的地的成员 多播组。
- 如果数据包的目标地址是 IP 广播地址（有限广播地址除外），并且至少寻址与数据包到达的物理接口关联的逻辑接口之一，则数据包将在本地传送。 数据包也会传递到转发器，除非数据包到达的链路使用的 IP 封装与单播不同（例如，通过使用不同的链路层目标地址）封装广播。
- 在所有其他情况下，数据包都会传递到转发器。

**讨论：**

​	第四个项目符号最后一句中的要求的目的是处理到同一物理电缆上另一个网络前缀的定向广播。 通常，这按预期工作：发送方将广播作为链路层单播发送到路由器。 路由器注意到它是作为单播到达的，因此必须指定与发送方发送它的网络前缀不同的网络前缀。 因此，路由器可以安全地将其作为链路层广播发送到其到达的同一（物理）接口。 但是，如果路由器无法判断数据包是否作为链路层单播接收，则该语句确保路由器执行安全但错误的操作，而不是不安全但正确的操作。

**实现：**

​	如第[5.3.4]节所述，通常不转发作为链路层广播接收的数据包。 避免将数据包传递给转发器可能是有利的，该转发器稍后会因为该部分中的规则而丢弃数据包。 某些链路层（由于硬件或驱动程序中的特殊代码）可以向路由器传送其传输的所有链路层广播和多播的副本。 使用此功能可以简化数据包必须传递到转发器并在本地传递的情况的实现，因为转发数据包将自动导致路由器接收数据包的副本，然后可以在本地传递数据包。 在这些情况下必须小心，以防止将收到的环回数据包视为收到的正常数据包（然后遵守转发规则等）。

​	即使没有这样的链路层，当然也几乎没有必要制作整个数据包的副本以将其排队以进行转发和本地传送，但必须小心分段，因为重组是在本地传送的数据包上执行的，而不是在本地传送的数据包上执行的。 在转发的数据包上。 一种简单的方案是将一个标志与路由器输出队列上的每个数据包相关联，该标志指示该数据包在发送后是否应排队等待本地传送。

#### 5.2.4 确定下一跳地址

​	当路由器要【转发】数据包时，它必须确定是否可以将其直接发送到目的地，或者是否需要通过另一个路由器将其传递。 如果是后者，则需要确定使用哪个路由器。 本节解释如何做出这些决定。

本节使用以下定义：

- LSRR：IP 松散源和记录路由选项
- SSRR：IP 严格源和记录路由选项 
- Source Route选项：LSRR 或 SSRR
- Ultimate Destination Address：最终目标地址，即数据包发送到的位置：源路由数据包的源路由中的最后一个地址，或非源路由数据包的 IP 标头中的目标地址
- 相邻 - 无需通过任何 IP 路由器即可到达
- 下一跳地址 - 数据包下一步应发送到的相邻主机或路由器的 IP 地址
- IP 目标地址 - 最终目标地址，源路由数据包中除外，它是源路由中指定的下一个地址
- 直接目标 - 节点、系统、路由器、终端系统或 IP 目标地址所寻址的任何内容。

##### 5.2.4.1 IP 目的地址

如果：

- IP header中的目标地址是路由器的地址之一， 
- 数据包包含【Source Route Option】，并且 
- 【Source Route Option】中的指针**【未指向】**该选项的末尾，

则下一个 IP 目标地址是**该选项中指针所指向的地址**。 如果：

- IP  header中的目标地址是路由器的地址之一，
- 数据包包含【Source Route Option】，并且
- 源路由选项中的指针**【指向】**该选项的末尾，

然后该消息被发送至分析该消息的系统。

在确定如何处理数据包时，路由器必须使用 IP 目标地址，而不是最终目标地址（源路由选项中的最后一个地址）。 **数据报中出现多个源路由选项是一种错误**。

如果它收到这样的数据报，它应该丢弃该数据包并回复一个 ICMP 参数问题消息，该消息的指针指向第二个源路由选项的开头。

##### 5.2.4.2 本地/远程决策

在确定需要根据[5.2.3]节中指定的规则转发IP数据包后，必须使用以下算法来确定【Immediate Destination】是否可直接访问（参见[INTERNET:2]）。 

1. 对于尚未分配任何 IP 地址的每个网络接口（如第 [2.2.7] 节中所述的未编号行），将线路另一端的 router-id 与 IP 目标地址进行比较。 如果它们完全相等，则数据包可以通过该接口传输。

**讨论：**

​	换句话说，线路远程端的路由器或主机是数据包的目的地，或者是源路由数据包的源路由中的下一步。

2. 如果在第一步中未选择任何网络接口，则对于分配给路由器的每个 IP 地址： 

   (a) 隔离该接口使用的网络前缀。

**实现** 

​	该操作的结果通常在初始化期间计算并保存。  

​	(b) 从数据包的 IP 目标地址中分离出相应的位组。 

​	(c) 比较结果网络前缀。 如果相等，则数据包可以通过相应的网络接口传输。  

3. 如果目的地既不是未编号接口上邻居的路由器 ID，也不是直接连接的网络前缀的成员，则 IP 目的地只能通过某个其他路由器访问。 路由器和下一跳IP地址的选择在[5.2.4.3]节中描述。 如果主机不是路由器，则这可能是配置的默认路由器。

​	IETF [ARCH:9, NRHP] 正在进行的工作考虑了某些情况，例如多个 IP（子）网络覆盖在同一链路层网络上时。 排除策略限制，如果存在足够的信息，使用公共链路层网络的主机和路由器即使不在同一IP（子）网络中也可以直接通信。 下一跳路由协议 (NHRP) 使 IP 实体能够确定用于穿过此类链路层网络到达远程目的地的“最佳”链路层地址。

4. 如果选定的“下一跳”可通过配置为使用 NHRP 的接口到达，则适用以下附加步骤：

   (a) 将 IP 目标地址与 NHRP 缓存中的目标地址进行比较。 如果该地址在缓存中，则将数据报发送到对应的缓存链路层地址。  

   (b) 如果该地址不在缓存中，则构造一个包含 IP 目标地址的 NHRP 请求数据包。 此消息将发送到为该接口配置的 NHRP 服务器。 这可能是路由器本身中逻辑上独立的进程或实体。

   (c) NHRP 服务器将使用正确的链路层地址进行响应，以用于将数据报和后续数据报传输到同一目的地。 系统可以在等待 NHRP 回复时将数据报传输到传统的“下一跳”路由器。

##### 5.2.4.3 下一跳地址

**编辑+评论**

​	路由器应用上一节中的算法来确定 IP 目标地址是否相邻。 如果是，则下一跳地址与 IP 目标地址相同。 否则，数据包必须通过另一个路由器转发才能到达其直接目的地。 该路由器的选择是本节的主题。 

​	如果数据包包含 SSRR，路由器必须丢弃该数据包并回复 ICMP 错误源路由错误。 否则，路由器会在其路由表中查找 IP 目标地址以确定适当的下一跳地址。 

**讨论** 

​	根据 IP 规范，严格源路由必须指定数据包必须经过的节点序列； 数据包必须从源路由的一个节点到达下一个节点，仅穿过中间网络。 因此，如果该路由器与源路由的下一步不相邻，则源路由不能被满足。 因此，路由器会拒绝此类请求，并显示 ICMP 错误源路由错误。

​	下一跳选择过程的目标是检查路由器转发信息库 (FIB) 中的条目，并从 FIB 中的可用路由中为数据包选择最佳路由（如果有）。 

​	从概念上讲，任何路由查找算法都从一组包含 FIB 全部内容的候选路由开始。 该算法由一系列从集合中丢弃路由的步骤组成。 这些步骤称为修剪规则。 通常，当算法终止时，集合中只剩下一条路由。 如果集合变空，则数据包将被丢弃，因为目的地无法到达。 当集合中保留多于一条路由时，算法也可能终止。 在这种情况下，路由器可以任意丢弃除其中一个以外的所有路由，或者可以通过选择最近最少使用的路由来执行“负载分配”。

除了规则 3（弱 TOS）之外，路由器在为数据包选择下一跳时必须使用以下修剪规则。 如果路由器在做出下一跳决策时确实考虑 TOS，则必须按下面所示的顺序应用规则 3。 这些规则必须（概念上）按照它们出现的顺序应用于 FIB。  （有关一些历史观点、附加修剪规则和其他常用算法，请参阅附录 E。）

讨论 规则 3 是可选的，[5.3.2] 节规定路由器在做出转发决策时只应该考虑 TOS。  (1) 基本匹配 该规则丢弃除数据包的 IP 目标地址之外的任何目的地的路由。 例如，如果数据包的 IP 目标地址是 10.144.2.5，则此步骤将丢弃到网络 128.12.0.0/16 的路由，但会保留到网络前缀 10.0.0.0/8 和 10.144.0.0/16 的所有路由，以及任何 默认路由。 更准确地说，我们假设每个路由都有一个目的地属性（称为route.dest）和相应的前缀长度（称为route.length），以指定route.dest的哪些位是重要的。 正在转发的数据包的 IP 目标地址是 ip.dest。 此规则丢弃候选集中的所有路由，除了那些route.dest 和ip.dest 的最高有效route.length 位相等的路由之外。 例如，如果数据包的 IP 目标地址为 10.144.2.5，并且存在网络前缀 10.144.1.0/24、10.144.2.0/24 和 10.144.3.0/24，则该规则将仅保留 10.144.2.0/24； 它是唯一一个其前缀与数据包的 IP 目标地址中的相应位具有相同值的路由。  (2) 最长匹配 如上所述，最长匹配是基本匹配的改进。 执行基本匹配修剪后，算法会检查剩余路由以确定其中哪些路由具有最大的route.length 值。 除了这些之外的所有内容都被丢弃。 例如，如果数据包的 IP 目标地址为 10.144.2.5，并且存在网络前缀 10.144.2.0/24、10.144.0.0/16 和 10.0.0.0/8，则此规则将仅保留第一个 (10.144.2.0/  24) 因为它的前缀长度最长。