

## 2. 互联网架构

### 2.2 架构的元素

#### 2.2.1 架构的元素

#### 2.2.2 网络

#### 2.2.3 路由器

​	在互联网模型中，各个组成网络主要通过IP数据报转发器（被称为路由器或IP路由器）连接在一起。在本文档中，每次使用“路由器”一词时均指代IP路由器。许多较旧的互联网文档将路由器称为网关。历史上，路由器是通过**在通用CPU上执行的数据包的交换**软件实现的。然而，随着定制硬件开发变得更加便宜以及对更高吞吐量的需求增加，专用硬件变得越来越普遍。本规范适用于无论其实现方式如何的路由器。

​	路由器连接到两个或多个逻辑接口，这些接口**由IP子网或未编号的点对点线路表示**（在第[2.2.7]节中讨论）。因此，它至少有一个物理接口。转发IP数据报通常需要路由器选择下一跳路由器的地址和相关接口，或者（对于最终跳）目标主机的地址或相关接口。**这个选择称为中继或者转发**（relaying或forwarding），它依赖于路由器内部的路由数据库。路由数据库也称为路由表或转发表。“路由器”一词源于构建这个路由数据库的过程；路由协议和配置在一个称为路由的过程中相互作用。

​	路由数据库应动态维护，以反映互联网系统的当前拓扑。路由器通常通过与其他路由器参与分布式路由和可达性算法来实现这一点。	路由器仅提供数据报传输，并试图最小化维持此服务所需的状态信息，以追求路由的灵活性和鲁棒性。

​	分组交换设备也可以在链路层运行； 此类设备通常称为**网桥**。 通过网桥连接的网段共享相同的 IP 网络前缀，形成单个 IP 子网。 这些其他设备不属于本文档讨论的范围。

#### 2.2.4 自治系统

​	自治系统 (AS) 是网络拓扑的连接段，由通过一组路由互连的子网集合（连接有主机）组成。 子网和路由器预计将由单个运营和维护 (O&M) 组织控制。  AS 内的路由器可能使用一个或多个内部路由协议，有时还使用几组度量。  AS 应该向其他 AS 呈现一致的内部路由计划以及通过 AS 可到达的目的地的一致图片。  AS 由自治系统编号来标识。  AS 的概念在 Internet 路由中起着重要作用（参见第 7.1 节）。

#### 2.2.5 寻址架构

​	IP 数据报携带 32 位源地址和目标地址，每个地址都分为两部分 ----- 组成网络前缀和该网络上的主机号。

```c
IP-address ::= { <Network-prefix>, <Host-number> }
```

​	为了最终传送数据报，其路径中的最后一个路由器必须将 IP 地址的主机号（或其余部分）映射到主机的MAC地址。

##### 2.2.5.1 经典IP寻址架构

​	尽管在其他地方 [INTERNET:2] 有详细记录，但描述网络前缀的历史使用还是很有用的。 为描述它而开发的语言在本文档和其他文档中使用，并渗透到许多协议背后的思想中。 最简单的经典网络前缀是 A、B、C、D 或 E 类网络前缀。 这些地址范围是通过观察地址最高有效位的值来区分的，并将地址分解为简单的前缀和主机号字段。  [INTERNET:18]对此进行了描述。 简而言之，分类就是：

```c
0xxx - Class A - general purpose unicast addresses with standard
8 bit prefix
10xx - Class B - general purpose unicast addresses with standard
16 bit prefix
110x - Class C - general purpose unicast addresses with standard
24 bit prefix
1110 - Class D - IP Multicast Addresses - 28 bit prefix, non-
aggregatable
1111 - Class E - reserved for experimental use    
```

​	这个简单的概念已通过子网的概念得到扩展。 引入这些是为了允许组织内互连 LAN 结构的任意复杂性，同时使互联网系统免受分配的网络前缀和路由复杂性的爆炸性增长的影响。 子网为互联网系统提供了多级分层路由结构。  [INTERNET:2] 中描述的子网扩展是 Internet 架构的必需部分。 基本思想是将 <Host-number> 字段分为两部分：子网号和该子网上的真实主机号：

```c
IP-address ::= { <Network-number>, <Subnet-number>, <Host-number> }
```

​	组织内互连的物理网络使用相同的网络前缀但不同的子网号。 这种子网网络的子网之间的区别通常在该网络外部不可见。 因此，Internet 其余部分中的路由仅使用 IP 目标地址的 <Network-prefix> 部分。 网络外部的路由器将 <网络前缀> 和 <主机号> 一起视为 32 位 IP 地址的未解释的其余部分。 在子网网络中，路由器使用扩展网络前缀：

```
{ <Network-number>, <Subnet-number> }
```

​	历史上，包含此扩展网络号的位位置由称为子网掩码的 32 位掩码指示。  <子网号> 位应该是连续的，并且位于 <网络号> 和 <主机号> 字段之间。 最新的协议不涉及子网掩码，而是涉及前缀长度； 地址的“前缀”部分是由子网掩码选择的部分，其最高有效位全为 1，其余为 0。 前缀的长度等于子网掩码中的个数。 本文档假设所有子网掩码都可以表示为前缀长度。

​	子网机制的发明者假设组织网络的每个部分都只有一个子网号。 在实践中，事实证明让多个子网共享一条物理电缆是必要的或有用的。 因此，路由器应该能够在同一物理接口上配置多个子网，并将它们（从路由或转发的角度）视为不同的物理接口。



##### 2.2.5.2 CIDR（无类别域间路由）

> Classless Inter Domain Routing

​	互联网的爆炸性增长迫使人们重新审视地址分配策略。 通用（A、B 和 C 类）网络的传统用途已被修改，以更好地利用 IP 的 32 位地址空间。 无类别域间路由 (CIDR) [INTERNET:15] 是目前部署在互联网骨干网中以实现这种更高效率的一种方法。  CIDR 取决于部署和路由到任意大小的网络。 在此模型中，主机和路由器不对互联网中寻址的使用做出任何假设。  **D 类（IP 多播）和 E 类（实验）地址空间被保留**，尽管这主要是一种分配策略。

​	根据定义，CIDR 包含三个元素： 

- 拓扑上重要的地址分配
- 能够聚合网络层可达性信息的路由协议，以及 
- 一致的转发算法（“最长匹配”）。 

​	网络和子网的使用现已成为历史，尽管用于描述它们的语言仍在使用。 它们已被更容易处理的网络前缀概念所取代。 根据定义，网络前缀是定义一组系统的地址较高端的一组连续位； 主机号在这些系统中进行选择。 不要求所有互联网都统一使用网络前缀。 为了折叠路由信息，将互联网划分为寻址域是有用的。 在这样的域内，可以获得有关组成网络的详细信息； 在其外部，仅通告公共网络前缀。 

​	经典的 IP 寻址架构使用地址和子网掩码来区分主机号和网络前缀。 对于网络前缀，指示前缀中的位数就足够了。 两种表示形式都很常用。 结构上正确的子网掩码能够使用前缀长度描述来表示。 它们包含所有可能的位模式的子集

- 较高有效端的连续 1， 
- 较低有效端的连续 0，以及 
- 没有中间位。

​	路由器应该始终将路由视为网络前缀，并且应该拒绝与该模型不一致的配置和路由信息。

```c
IP-address ::= { <Network-prefix>, <Host-number> }
```

​	使用 CIDR 的一个效果是与路由表中的地址前缀相关联的目的地集合可以表现出子集关系。 描述较小的目的地集合（较长的前缀）的路由被认为比描述较大的目的地集（较短的前缀）的路由更具体； 类似地，描述较大的目的地集合（较短的前缀）的路由被认为比描述较小的目的地集合（较长的前缀）的路由更不具体。 **路由器在转发流量时必须使用最具体的匹配路由（最长的匹配网络前缀）**。



#### 2.2.6 IP组播

​	IP 组播是链路层组播到IP 互联网的扩展。 使用 IP 多播，可以将单个数据报寻址到多个主机，而无需将其发送给所有主机。 在扩展情况下，这些主机可能驻留在不同的地址域中。 **这个主机集合称为组播组**。 每个组播组都表示为 D 类 IP 地址。 发送到组的 IP 数据报将以与单播 IP 流量相同的尽力传送方式传送到每个组成员。 **数据报的发送者本身不需要是目标组的成员。**

​	IP 多播组成员资格的语义在 [INTERNET:4] 中定义。 该文档描述了主机和路由器如何加入和离开多播组。 它还定义了一种协议，即 Internet 组管理协议 (IGMP)，用于监视 IP 多播组成员资格。  

​	IP多播组成员资格的语义在文档[INTERNET:4]中进行了定义。该文档描述了主机和路由器如何加入和离开多播组。它还定义了一种协议，即互联网组管理协议（IGMP），用于监控IP多播组成员资格。

​	IP多播数据报的转发是通过静态路由信息或通过组播路由协议实现的。转发IP组播数据报的设备称为组播路由器。这些设备可能同时也会转发IP单播数据。组播数据报的转发是基于其源地址和目标地址进行的。IP组播数据包的转发将在第[5.2.1]节中更详细地描述。附录D讨论了组播路由协议。

#### 2.2.7 未编号的线路和网络前缀

​	传统上，IP 主机或路由器上的每个网络接口都有自己的 IP 地址。 这可能会导致稀缺 IP 地址空间的使用效率低下，因为它会强制为每个点对点链路分配 IP 网络前缀。 

​	为了解决这个问题，许多人提出并实现了**无编号点对点线路**的概念。 未编号的点对点线路没有任何与其关联的网络前缀。 因此，连接到未编号点对点线路的网络接口没有 IP 地址。 

​	由于 IP 架构传统上假设所有接口都有 IP 地址，因此这些未编号的接口会导致一些有趣的困境。 例如，某些 IP 选项（例如，记录路由）指定路由器必须将接口地址插入到选项中，但未编号的接口没有 IP 地址。 更基本的（正如我们将在第 5 章中看到的）是路由包含下一跳路由器的 IP 地址。 路由器期望该 IP 地址位于该路由器所连接的 IP（子）网上。 如果唯一的连接是未编号的点对点线，那么当然会违反该假设。 

​	为了解决这些困难，提出了两种方案。 第一种方案表示，**通过未编号的点对点线路连接的两个路由器根本不是真正的两个路由器，而是两个半路由器，它们一起组成一个虚拟路由器。** 未编号的点对点线路本质上被认为是虚拟路由器中的内部总线。 虚拟路由器的两半必须协调它们的活动，使它们的行为与单个路由器完全相同。 

​	该方案非常适合 IP 架构，但有两个重要的缺点。 第一个是，虽然它处理单个未编号点对点线路的常见情况，但它不容易扩展以处理路由器网格和未编号点对点线路的情况。 第二个缺点是半路由器之间的交互必然复杂且不标准化，有效地排除了来自不同供应商的设备使用无编号的点对点线路的连接。

​	由于这些缺点，本备忘录**采用了一种替代方案**，该方案已被多次发明，但最初可能是菲尔·卡恩 (Phil Karn) 提出的。 **在此方案中，具有未编号的点对点线路的路由器也有一个特殊的 IP 地址，在本备忘录中称为 router-id**。  router-id 是路由器的 IP 地址之一（路由器必须至少有一个 IP 地址）。 使用此路由器 ID 就好像它是所有未编号接口的 IP 地址一样。

#### 2.2.8 值得注意的怪事

##### 2.2.8.1 嵌入式路由器

​	路由器可以是独立的计算机系统，专用于其IP路由器功能。 或者，可以将路由器功能嵌入到支持连接到两个或多个网络的主机操作系统中。 具有嵌入式路由器代码的操作系统的最著名示例是 Berkeley BSD 系统。 嵌入式路由器功能看似使构建网络变得容易，但它有许多隐藏的陷阱：

​	 (1)  如果主机只有一个组成网络接口，它不应该充当路由器。

​		例如，具有嵌入式路由器代码的主机在同一网络上无偿转发广播数据包或数据报通常会导致数据包雪崩。 

​	 (2) 如果（多宿主）主机充当路由器，则它须遵守本文档中包含的路由器要求。 

​		例如，路由协议问题以及路由器控制和监控问题对于嵌入式路由器和独立路由器来说同样困难且重要。 互联网路由器的要求和		规格可能会随着操作系统的变化而变化。 强烈建议在互联网中运行嵌入式路由器的管理部门维护和更新路由器代码。 这可能需		要路由器源代码。  

​	(3) 当主机执行嵌入式路由器代码时，它就成为互联网基础设施的一部分。 因此，软件或配置中的错误可能会阻碍其他主机之间的通信。 结果，主机管理员必须失去一些自主权。 在许多情况下，主机管理员需要禁用操作系统中嵌入的路由器代码。 因此，禁用嵌入式路由器功能应该很简单。

​	(4) 当运行嵌入式路由器代码的主机同时用于其他服务时，两种使用模式的运维要求可能会发生冲突。 例如，路由器的运维很多情况下是由运营中心远程进行； 这可能需要主机管理员通常不希望分配的特权系统访问权限。

##### 2.2.8.2 透明路由器

​	在互联网中互连局域网和广域网（或长途）有两种基本模型。 首先，为局域网分配一个网络前缀，并且 Internet 中的所有路由器都必须知道如何路由到该网络。 在第二种情况下，局域网共享广域网（一小部分）的地址空间。 支持第二种模型的路由器称为地址共享路由器或透明路由器。 本备忘录的重点是支持第一种模型的路由器，但这并不意味着排除透明路由器的使用。 

​	透明路由器的基本思想是，路由器后面的局域网上的主机共享路由器前面的广域网的地址空间。 在某些情况下，这是一种非常有用的方法，并且这些限制不会带来重大缺陷。

​	前面和后面的文字表明了这种方法的局限性之一：这种互连模型仅适用于地理（和拓扑）有限的存根环境。 它要求在广域网的网络级寻址中存在某种形式的逻辑寻址。 本地环境中的 IP 地址映射到广域网中的几个（通常是一个）物理地址。 此映射的发生方式与整个广域网中使用的 { IP 地址 <-> 网络地址 } 映射一致。 

​	在一个广域网上可以实现多宿主，但如果接口在地理上或拓扑上分离，则可能会出现路由问题。 由于地址混乱，两个（或多个）广域网上的多宿主是一个问题。

​	如果透明路由器无法完全模拟正常的广域网服务，则主机从表面上同一网络中的其他主机看到的行为可能会有所不同。 例如，阿帕网使用链路层协议，该协议提供“目的地失效”指示，以响应向离线主机发送数据的尝试。 然而，如果 ARPANET 和以太网之间存在透明路由器，则 ARPANET 上的主机将不会收到以太网主机的“目的地失效”指示。

### 2.3 路由器特性

​	Internet 路由器执行以下功能：

​	(1) 符合本文档中指定的特定 Internet 协议，包括 Internet 协议 (IP)、Internet 控制消息协议 (ICMP) 以及其他必要的协议。 

​	(2) 到两个或多个分组网络的接口。 对于每个连接的网络，路由器必须实现该网络所需的功能。 这些功能通常包括： 使用连接的网络帧（例如，以太网标头和校验和）封装和解封装 IP 数据报， 

- 发送和接收 IP 数据报，最大尺寸为该网络支持的最大大小，该大小是网络的最大传输 单位或 MTU， 

- 如果需要，将 IP 目标地址转换为所连接网络的适当网络级地址（例如以太网硬件地址），以及 

- 响应网络流量控制和错误指示（如果有）。 

  请参见第 3 章（链路层）。  

  (3) 接收和转发Internet数据报。 这个过程中的重要问题是缓冲区管理、拥塞控制和公平性。

  - 识别错误情况并根据需要生成 ICMP 错误和信息消息。  
  - 丢弃生存时间字段已达到零的数据报。  
  - 必要时对数据报进行分段以适应下一个网络的 MTU。 
    - 有关详细信息，请参阅第 4 章（互联网层 - 协议）和第 5 章（互联网层 - 转发）。

​	(4) 根据路由数据库中的信息，为每个 IP 数据报选择下一跳目的地。 有关详细信息，请参阅第 5 章（互联网层 - 转发）。

​	(5)（通常）支持内部网关协议（IGP）以与同一自治系统中的其他路由器执行分布式路由和可达性算法。 此外，一些路由器需要支持外部网关协议（EGP）以与其他自治系统交换拓扑信息。 有关详细信息，请参阅第 7 章（应用层 - 路由协议）。  

​	(6)提供网络管理和系统支持设施，包括加载、调试、状态报告、异常报告和控制。 有关详细信息，请参阅第 8 章（应用层网络管理协议）和第 10 章（操作和维护）。

​	路由器供应商在特定路由器产品的功率、复杂性和功能方面有多种选择。 观察互联网系统既不是同质的也不是完全连接的可能会有所帮助。 由于技术和地理的原因，它正在发展成为一个全球互连系统以及边缘的 LAN 边缘。 越来越多的这些边缘 LAN 的互连程度越来越高，从而使它们不再处于边缘，对路由器的要求也越来越高。

- 全球互连系统由许多广域网组成，其中连接了多个自治系统（AS）的路由器； 直接连接到系统的主机相对较少。
- 大多数主机都连接到 LAN。 许多组织都有通过本地路由器互连的 LAN 集群。 每个这样的集群都通过路由器在一个或多个点连接到全球互连系统中。 如果仅在一个点连接，则 LAN 称为末节网络。

全球互连系统中的路由器通常需要：

- 高级路由和转发算法

  这些路由器需要高度动态的路由算法，施加最小的处理和通信负担，并提供服务类型路由。 拥塞仍然是一个没有完全解决的问题（参见第[5.3.6]节）。 由于研究界正在积极研究这些问题，因此预计这些领域会得到改进。

- 高可用性

  这些路由器需要高度可靠，提供每周 7 天、每天 24 小时的服务。 设备和软件故障可能会产生广泛的（有时是全球性的）影响。 一旦失败，他们必须迅速恢复。 在任何环境中，路由器都必须高度稳健，并且能够在网络资源极度拥塞或故障的情况下（可能处于降级状态）运行。

- 先进的运维特性

  互联网路由器通常以无人值守模式运行。 它们通常从集中监控中心远程操作。 他们需要提供复杂的手段来监视和测量流量和其他事件以及诊断故障。

- 高性能

  当今互联网中的长途线路最常见的是全双工 56 KBPS、DS1 (1.544 Mbps) 或 DS3 (45 Mbps) 速度。  LAN 是半双工多路访问介质，通常是以太网 (10Mbps)，也有少数是 FDDI (100Mbps)。 然而，网络媒体技术正在不断进步，未来可能会有更高的速度。

​	LAN 边缘（例如校园网）中使用的路由器的要求很大程度上取决于本地网络的需求。 这些可能是高性能或中等性能的设备，可能是从几个不同的供应商竞争性采购的，并由内部组织（例如，校园计算中心）运营。 这些路由器的设计应强调低平均延迟和良好的突发性能，以及延迟和服务类型敏感的资源管理。 在这种环境下，运维可能不太正式，但也不会那么重要。 随着网络变得更加复杂和互连，对高度动态的路由机制的需求将变得更加重要。 由于全球互连的速度，用户将对本地连接提出更多要求。 

​	随着网络的发展，以及越来越多的网络变得足够老旧以至于正在逐步淘汰旧设备，路由器与其他供应商的路由器互操作变得越来越重要。

​	尽管互联网系统没有完全互连，但系统的许多部分都需要具有冗余连接。 尽管通信线路和路由器发生故障，丰富的连接性仍然可以提供可靠的服务，并且还可以通过缩短互联网路径和提供额外的容量来改善服务。 不幸的是，这种更丰富的拓扑会使选择到达特定目的地的最佳路径变得更加困难。

### 2.4 架构假设

​	当前的互联网架构基于一组有关通信系统的假设。 与路由器最相关的假设如下：

- 互联网是网络的网络。 

  每个主机都直接连接到某个特定的网络； 它与互联网的连接只是概念性的。 同一网络上的两台主机使用与远程网络上的主机通信时使用的同一组协议进行相互通信。

- 路由器不保存连接状态信息。 

  为了提高通信系统的鲁棒性，路由器被设计为无状态的，独立于其他数据包转发每个 IP 数据包。 因此，即使中间路由器和网络出现故障，也可以利用冗余路径来提供稳健的服务。 端到端流量控制和可靠性所需的所有状态信息都在主机、传输层或应用程序中实现。 因此，所有连接控制信息都与通信端点位于同一位置，因此只有当端点发生故障时才会丢失。 路由器仅通过丢弃数据包或增加网络延迟来间接控制消息流。 请注意，未来的协议开发很可能最终会将更多状态放入路由器中。 这对于多播路由、资源预留和基于流的转发尤其可能。  

- 路由的复杂性应该在路由器中。 

  路由是一个复杂而困难的问题，应该由路由器而不是主机来执行。 一个重要的目标是使主机软件免受因互联网路由架构不可避免的演变而引起的变化。

- 系统必须能够容忍广泛的网络变化。

  互联网设计的基本目标是容忍广泛的网络特性，例如带宽、延迟、数据包丢失、数据包重新排序和最大数据包大小。 另一个目标是使用仍然可用的任何带宽，抵御各个网络、路由器和主机故障的鲁棒性。 最后，目标是完全开放的系统互连：互联网路由器必须能够通过不同的互联网路径与任何其他路由器或互联网主机稳健且有效地互操作。 

  有时，实施者的设计目标并不那么雄心勃勃。 例如，LAN 环境通常比整个 Internet 环境要好得多；  LAN 的数据包丢失和延迟较低，并且不会对数据包重新排序。 一些供应商已经提供了足以满足简单 LAN 环境的实现，但对于一般互操作来说效果不佳。 供应商认为这种产品在受限的 LAN 市场中是经济的。 然而，孤立的 LAN 很少会长期保持孤立状态。 它们很快就会相互连接，连接到整个组织范围的互联网，并最终连接到全球互联网系统。 最终，客户和供应商都不会使用不完整或不合格的路由器。 

  本文档中的要求是针对全功能路由器而设计的。 完全兼容的路由器将可用于互联网的几乎任何部分。



## 4. 互联网层 - 协议

### 4.1 简介 

本章和第 5 章讨论互联网层使用的协议：IP、ICMP 和 IGMP。 由于转发显然是讨论路由器的文档中的一个关键主题，因此第 5 章仅限于与转发直接相关的协议方面。 本章包含互联网层协议讨论的其余部分。

### 4.2 IP协议

#### 4.2.1 介绍

​	路由器必须实现 [INTERNET:1] 定义的 IP 协议。 它们还必须实现其强制扩展：子网（在 [INTERNET:2] 中定义）、IP 广播（在 [INTERNET:3] 中定义）和无类域间路由（CIDR，在 [INTERNET:15] 中定义）。 

​	路由器实现者无需考虑遵守 [INTRO:2] 中标题为“Internet 协议 - IP”的部分，因为该部分在本文档中完全重复或被取代。 路由器必须并且应该无条件地符合 [INTRO:2] 中与 IP 相关的标题为“具体问题”的部分的要求。 

​	下面，在某些情况下指定的操作是静默丢弃接收到的数据报。 这意味着数据报将被丢弃而不进行进一步处理，并且路由器将不会因此发送任何 ICMP 错误消息（参见第 [4.3] 节）。 然而，为了诊断问题，路由器应该提供记录错误的能力（参见第[1.3.3]节），包括默默丢弃的数据报的内容，并且应该对丢弃的数据报进行计数。





## 5. 互联网层 - 转发

### 5.1 介绍

本节介绍了报文转发的过程。

### 5.2 转发演练

​	IP中没有单独的转发功能规范。 相反，转发由互联网层协议（[INTERNET:1]、[INTERNET:2]、[INTERNET:3]、[INTERNET:8] 和 [ROUTE:11]）的协议规范涵盖。

#### 5.2.1 转发算法

​	由于主要协议文档都没有详细描述转发算法，因此我们在这里介绍它。 这只是一个总体概述，省略了重要的细节，例如拥塞的处理，这些细节将在后面的部分中讨论。 不要求实现完全遵循[5.2.1.1]、[5.2.1.2]和[5.2.1.3]节中给出的算法。 编写路由器软件的大部分挑战是**最大化路由器转发数据包的速率**，同时仍然实现相同的算法效果。 有关如何执行此操作的详细信息超出了本文档的范围，部分原因是它们严重依赖于路由器的体系结构。 相反，我们只是指出步骤之间的顺序依赖性：

1. 在根据标头内容执行任何操作之前，路由器必须验证 IP header，如第 [5.2.2] 节所述。 这使得路由器能够在消耗其他资源之前检测并丢弃坏数据包。
2. 处理某些IP选项需要路由器将其IP地址插入到选项中。 如第 [5.2.4] 节所述，**插入的地址必须是发送数据包的逻辑接口的地址**，或者**如果数据包是通过未编号的接口发送的，则插入的地址必须是路由器的 router-id**。 因此，只有在选择输出接口之后才能完成这些选项的处理。
3. 由于第[4.2.2.9]节中提到的原因，路由器在检查数据包是否应传递到路由器本身之前无法检查并递减 TTL。
4. 更一般地，当数据包在本地传送到路由器时，不得以任何方式修改其 IP 标头（除非路由器可能需要将时间戳插入到 IP 标头中的任何时间戳选项中）。 因此，在路由器确定数据包是否要本地传送到路由器之前，它不能以任何不准备撤消的方式更新IP报头。



##### 5.2.1.1 General

本节介绍一般转发算法。 该算法适用于要转发的所有形式的数据包：**单播、组播和广播**。

1. 路由器从链路层接收 IP 数据包（以及有关它的附加信息，如第 [3.1] 节所述）。

2. 路由器验证 IP头，如第 [5.2.2] 节所述。 请注意，IP 重组不会完成，除了在步骤 (4) 中排队等待本地传送的 IP 片段之外。 

3. 路由器执行任何 IP 选项的大部分处理。 如第[5.2.4]节所述，一些IP选项在做出路由决定后需要额外的处理。 

4. 路由器检查IP数据报的目的IP地址，如第[5.2.3]节所述，以确定它应如何继续处理IP数据报。 存在三种可能性：

   - IP 数据报的目的地是路由器，并且应该排队等待本地转发，并在需要时进行重组。
   - IP 数据报不是发往路由器的，应排队等待转发。
   - IP 数据报应排队等待转发，但（副本）也必须排队等待本地转发。

   

##### 5.2.1.2 单播

由于 [INTRO:2] 很好地涵盖了本地传送情况，因此下面**【假设 IP 数据报已排队等待转发】**。

如果目标是 IP 单播地址：

5. 【转发器】通常通过在路由器的路由表中查找数据包的目的地来确定数据包的下一跳 IP 地址。 该过程在[5.2.4]节中有更详细的描述。 此过程还决定哪个网络接口应该用于发送数据包。
6. 【转发器】验证是否允许转发数据包。 源地址和目标地址应该是有效的，如第 [5.3.7] 节和第 [5.3.4] 节中所述。 如果路由器支持转发的管理约束，例如第 [5.3.9] 节中所述的那些约束，则这些约束必须是 使满意。
7. 【转发器】递减（至少 1）并检查数据包的 TTL，如第 [5.3.1] 节中所述。  
8. 【转发器】执行步骤 3 中无法完成的任何 IP 选项处理。
   1. 【转发器】执行任何必要的 IP 分段，如第 [4.2.2.7] 节中所述。 由于此步骤发生在出接口选择（步骤5）之后，因此同一数据报的所有片段都将从同一接口发送出去。
9. 【转发器】确定数据包下一跳的链路层地址。 执行此操作的机制取决于链路层（请参阅第 3 章）。
10. 【转发器】将 IP 数据报（或其每个片段）封装在适当的链路层帧中，并将其排队以便在步骤 5 中选择的接口上输出。
11. 【转发器】在必要时发送 ICMP 重定向，如第 [ 4.3.3.2]中所述。。

##### 5.2.1.3 组播

如果目的地是 IP 多播，则执行以下步骤。 请注意，IP 单播转发和 IP 多播转发之间的主要区别是

- IP 组播通常根据数据报的源 IP 地址和目标 IP 地址进行转发
- IP 组播使用扩展环搜索
- IP 组播转发为 **链路级组播**，并且 ICMP 错误永远不会发送以响应 IP 多播数据报。

请注意，IP 组播转发仍处于实验阶段。 因此，下面提出的算法不是强制性的，并且仅作为示例提供。

(5a) 根据数据报报头中找到的 IP 源地址和目标地址，路由器确定是否已在正确的接口上接收到数据报并进行转发。 如果不是，则数据报将被静默丢弃。 确定正确接收接口的方法取决于所使用的多播路由算法。 在最简单的算法之一——反向路径转发（RPF）中，**正确的接口是用于将单播转发回数据报源的接口**。

(6a) 根据数据报报头中的 IP 源地址和目标地址，②路由器确定数据报的传出接口。 为了实现 IP 多播的扩展环搜索（参见[INTERNET:4]），为每个传出接口指定了最小 TTL 值。 通过在每个最小 TTL 值小于或等于数据报头中的 TTL 值的传出接口上单独应用剩余步骤，将多播数据报的副本转发出每个此类接口。

(7a) 路由器将数据包的 TTL 减 1。

(8a)转发器执行步骤(3)中无法完成的任何IP选项处理。 

 (9a) 转发器执行任何必要的 IP 分段，如第 [4.2.2.7] 节中所述。  

(10a) 转发器确定在链路层封装中使用的链路层地址。 执行此操作的机制取决于链路层。 在 LAN 上，选择链路级多播或广播作为数据报 IP 多播地址的算法转换。 有关更多详细信息，请参阅各种 IP-over-xxx 规范。 

 (11a) 转发器将数据包（或其每个片段）封装在适当的链路层帧中，并将其排队以便在适当的接口上输出。



#### 5.2.2 IP头验证

在路由器可以处理任何 IP 数据包之前，它必须对数据包的 IP 标头执行以下基本有效性检查，以确保标头有意义。 如果数据包未通过以下任何测试，则必须将其静默丢弃，并且应记录错误。

(1) 链路层报告的**packet length必须足够大以容纳最小长度的合法IP数据报（20字节）**。  

(2) IP checksum必须正确。 

(3) IP version必须为4。如果版本号不是4，则该数据包可能是另一个版本的IP，例如IPng或ST-II。  

(4) IP header长度字段必须足够大，以容纳最小长度的合法 IP 数据报（20 字节 = 5 个字）。 

(5) IP total length字段必须足够大以容纳IP数据报报头，其长度在IP header length字段中指定。

路由器不得有允许禁用任何这些测试的配置选项。 

如果数据包通过了第二次和第三次测试，IP头长度字段至少为4，并且IP total length字段和链路层报告的数据包长度都至少为16，那么，尽管有上述规则，路由器可以 响应ICMP参数问题消息，其指针指向IP头长度字段（如果第四次测试失败）或IP总长度字段（如果第五次测试失败）。 然而，它仍然必须丢弃数据包并且仍然应该记录错误。 

这些规则（以及整个文档）仅适用于互联网协议的第 4 版。 这些规则不应被解释为禁止路由器支持其他版本的 IP。 此外，如果路由器能够真正将数据包分类为 IP 的其他版本，那么它不应该将该数据包视为本备忘录上下文中的错误数据包。

**实现** 

为了错误报告的目的，需要确定报头无效的原因，尽管并不总是完全可能。 可能的原因有四个：

- 链路层截断了 IP 标头。
- 数据报使用的是标准 IP 版本（版本 4）以外的 IP 版本。
- IP 标头在传输过程中已损坏。
- 发送方生成了非法的 IP 标头。

​	可能需要按照列出的顺序执行检查，因为我们相信这种顺序最有可能正确地对错误原因进行分类。 出于错误报告的目的，还可能需要检查未通过这些测试的数据包是否具有指示 IPng 或 ST-II 的 IP 版本号； 这些应根据各自的规范进行处理。

此外，路由器应该验证链路层报告的数据包长度至少与数据包的 IP 标头中记录的 IP 总长度一样大。 如果数据包看起来已被截断，则必须丢弃该数据包，应记录错误，并且路由器应使用 ICMP 参数问题消息进行响应，该消息的指针指向 IP 总长度字段。



**讨论** 

​	由于任何涉及数据损坏的高层协议都会在数据包数据到达其最终目的地时检测到数据包数据的截断，因此路由器不一定需要执行上述建议的检查来维护协议的正确性。 然而，通过进行此检查，路由器可以大大简化确定路径中的哪一跳正在截断数据包的任务。 它还将减少路由器下游的资源消耗，因为下游系统不需要处理数据包。



最后，如果 IP 标头中的目标地址不是路由器的地址之一，则路由器应该验证数据包不包含严格源和记录路由选项。 如果数据包未通过此测试（如果它包含严格的源路由选项），则路由器应记录该错误，并应使用 ICMP 参数问题错误进行响应，其中指针指向有问题的数据包的 IP 目标地址。

**讨论** 

​	有些人可能建议路由器应该响应 Bad Source Route 消息而不是 Parameter Problem 消息。 然而，当数据包未通过此测试时，通常表明前一跳路由器存在协议错误，而错误源路由则表明源主机请求的网络路径不存在或已损坏。



#### 5.2.3 本地分发决定

当路由器接收到 IP 数据包时，它必须决定该数据包是【发送】至【路由器（并应在本地传送）】还是【发送】至【另一个系统（并应由转发器处理】）。 还有一种混合情况，其中某些 IP 广播和 IP 多播既在本地传送又转发。 路由器必须使用以下规则确定这三种情况中的哪一种适用。

- 未过期的源路由选项是指其指针值未指向源路由中最后一个条目的选项。 如果数据包包含未过期的源路由选项，则选项中的指针会前进，直到指针确实指向选项中的最后一个地址，或者下一个地址不是路由器自己的地址之一。 在后一种（正常）情况下，无论以下规则如何，都会转发数据包（而不是在本地传递）。
- 在以下情况下，数据包在本地传送，不考虑转发：
  -  数据包的目标地址与路由器的 IP 地址之一完全匹配
  - 数据包的目标地址是有限广播地址 ({-1, -1})，或者
  - 数据包的目的地是从不转发的 IP 多播地址（例如 224.0.0.1 或 224.0.0.2），并且（至少）与数据包到达的物理接口关联的逻辑接口之一是目的地的成员 多播组。
- 在以下情况下，数据包将传递到转发器并在本地传送：
  - 数据包的目标地址是一个 IP 广播地址，它至少寻址路由器的一个逻辑接口，但不寻址与数据包到达的物理接口关联的任何逻辑接口
  - 数据包的目的地是允许转发的 IP 多播地址（与 224.0.0.1 和 224.0.0.2 不同），并且（至少）与数据包到达的物理接口关联的逻辑接口之一是目的地的成员 多播组。
- 如果数据包的目标地址是 IP 广播地址（有限广播地址除外），并且至少寻址与数据包到达的物理接口关联的逻辑接口之一，则数据包将在本地传送。 数据包也会传递到转发器，除非数据包到达的链路使用的 IP 封装与单播不同（例如，通过使用不同的链路层目标地址）封装广播。
- 在所有其他情况下，数据包都会传递到转发器。

**讨论：**

​	第四个项目符号最后一句中的要求的目的是处理到同一物理电缆上另一个网络前缀的定向广播。 通常，这按预期工作：发送方将广播作为链路层单播发送到路由器。 路由器注意到它是作为单播到达的，因此必须指定与发送方发送它的网络前缀不同的网络前缀。 因此，路由器可以安全地将其作为链路层广播发送到其到达的同一（物理）接口。 但是，如果路由器无法判断数据包是否作为链路层单播接收，则该语句确保路由器执行安全但错误的操作，而不是不安全但正确的操作。

**实现：**

​	如第[5.3.4]节所述，通常不转发作为链路层广播接收的数据包。 避免将数据包传递给转发器可能是有利的，该转发器稍后会因为该部分中的规则而丢弃数据包。 某些链路层（由于硬件或驱动程序中的特殊代码）可以向路由器传送其传输的所有链路层广播和多播的副本。 使用此功能可以简化数据包必须传递到转发器并在本地传递的情况的实现，因为转发数据包将自动导致路由器接收数据包的副本，然后可以在本地传递数据包。 在这些情况下必须小心，以防止将收到的环回数据包视为收到的正常数据包（然后遵守转发规则等）。

​	即使没有这样的链路层，当然也几乎没有必要制作整个数据包的副本以将其排队以进行转发和本地传送，但必须小心分段，因为重组是在本地传送的数据包上执行的，而不是在本地传送的数据包上执行的。 在转发的数据包上。 一种简单的方案是将一个标志与路由器输出队列上的每个数据包相关联，该标志指示该数据包在发送后是否应排队等待本地传送。

#### 5.2.4 确定下一跳地址

​	当路由器要【转发】数据包时，它必须确定是否可以将其直接发送到目的地，或者是否需要通过另一个路由器将其传递。 如果是后者，则需要确定使用哪个路由器。 本节解释如何做出这些决定。

本节使用以下定义：

- LSRR：宽松路由选项
- SSRR：严格路由选项

> LSRR在选项的ip地址列表中并不列出一条完备而严格的路径，而是只给出路径中的某些关键点。在关键的之间可以通过路由器的自动路由选择功能进行路由，此选项在数据包分片的时候也必须被复制。 
>
> SSRR选项要求数据包必须严格按照发送方规定的路径经过每一个路由器，这些路由器应该是一一相连的，每两个指定的路由器之间不能有其他未指定的路由器，且路由器的顺序是不能改变的。如果数据包在传输时无法直接到达下一跳指定的路由器，路由器就会丢弃该数据包，然后产生一个源路由失败的目的不可达的ICMP差错报文报告给发送方。

- Source Route选项：LSRR 或 SSRR
- Ultimate Destination Address：最终目标地址，即数据包发送到的位置：源路由数据包的源路由中的最后一个地址，或非源路由数据包的 IP 标头中的目标地址
- 相邻 - 无需通过任何 IP 路由器即可到达
- 下一跳地址 - 数据包下一步应发送到的相邻主机或路由器的 IP 地址
- IP 目标地址 - 最终目标地址，源路由数据包中除外，它是源路由中指定的下一个地址
- 直接目标 - 节点、系统、路由器、终端系统或 IP 目标地址所寻址的任何内容。

##### 5.2.4.1 IP 目的地址

如果：

- IP header中的目标地址是路由器的地址之一， 
- 数据包包含【Source Route Option】，并且 
- 【Source Route Option】中的指针**【未指向】**该选项的末尾，

则下一个 IP 目标地址是**该选项中指针所指向的地址**。 如果：

- IP  header中的目标地址是路由器的地址之一，
- 数据包包含【Source Route Option】，并且
- 源路由选项中的指针**【指向】**该选项的末尾，

然后该消息被发送至分析该消息的系统。

在确定如何处理数据包时，路由器必须使用 IP 目标地址，而不是最终目标地址（源路由选项中的最后一个地址）。 **数据报中出现多个源路由选项是一种错误**。

如果它收到这样的数据报，它应该丢弃该数据包并回复一个 ICMP 参数问题消息，该消息的指针指向第二个源路由选项的开头。

##### 5.2.4.2 本地/远程决策

在确定需要根据[5.2.3]节中指定的规则转发IP数据包后，必须使用以下算法来确定【Immediate Destination】是否可直接访问（参见[INTERNET:2]）。 

1. 对于尚未分配任何 IP 地址的每个网络接口（如第 [2.2.7] 节中所述的未编号行），将线路另一端的 router-id 与 IP 目标地址进行比较。 如果它们完全相等，则数据包可以通过该接口传输。

**讨论：**

​	换句话说，线路远程端的路由器或主机是数据包的目的地，或者是源路由数据包的源路由中的下一步。

2. 如果在第一步中未选择任何网络接口，则对于分配给路由器的每个 IP 地址： 

   (a) 隔离该接口使用的网络前缀。

**实现** 

​	该操作的结果通常在初始化期间计算并保存。  

​	(b) 从数据包的 IP 目标地址中分离出相应的位组。 

​	(c) 比较结果网络前缀。 如果相等，则数据包可以通过相应的网络接口传输。  

3. 如果目的地既不是未编号接口上邻居的路由器 ID，也不是直接连接的网络前缀的成员，则 IP 目的地只能通过某个其他路由器访问。 路由器和下一跳IP地址的选择在[5.2.4.3]节中描述。 如果主机不是路由器，则这可能是配置的默认路由器。

​	IETF [ARCH:9, NRHP] 正在进行的工作考虑了某些情况，例如多个 IP（子）网络覆盖在同一链路层网络上时。 排除策略限制，如果存在足够的信息，使用公共链路层网络的主机和路由器即使不在同一IP（子）网络中也可以直接通信。 下一跳路由协议 (NHRP) 使 IP 实体能够确定用于穿过此类链路层网络到达远程目的地的“最佳”链路层地址。

4. 如果选定的“下一跳”可通过配置为使用 NHRP 的接口到达，则适用以下附加步骤：

   (a) 将 IP 目标地址与 NHRP 缓存中的目标地址进行比较。 如果该地址在缓存中，则将数据报发送到对应的缓存链路层地址。  

   (b) 如果该地址不在缓存中，则构造一个包含 IP 目标地址的 NHRP 请求数据包。 此消息将发送到为该接口配置的 NHRP 服务器。 这可能是路由器本身中逻辑上独立的进程或实体。

   (c) NHRP 服务器将使用正确的链路层地址进行响应，以用于将数据报和后续数据报传输到同一目的地。 系统可以在等待 NHRP 回复时将数据报传输到传统的“下一跳”路由器。

##### 5.2.4.3 下一跳地址

**编辑+评论**

​	路由器应用上一节中的算法来确定 IP 目标地址是否相邻。 如果是，则下一跳地址与 IP 目标地址相同。 否则，数据包必须通过另一个路由器转发才能到达其直接目的地。 该路由器的选择是本节的主题。 

​	如果数据包包含 SSRR，路由器必须丢弃该数据包并回复 ICMP 错误源路由错误。 否则，路由器会在其路由表中查找 IP 目标地址以确定适当的下一跳地址。 

**讨论** 

​	根据 IP 规范，严格源路由必须指定数据包必须经过的节点序列； 数据包必须从源路由的一个节点到达下一个节点，仅穿过中间网络。 因此，如果该路由器与源路由的下一步不相邻，则源路由不能被满足。 因此，路由器会拒绝此类请求，并显示 ICMP 错误源路由错误。

​	下一跳选择过程的目标是检查路由器转发信息库 (FIB) 中的条目，并从 FIB 中的可用路由中为数据包选择最佳路由（如果有）。 

​	从概念上讲，任何路由查找算法都从一组包含 FIB 全部内容的候选路由开始。 该算法由一系列从集合中丢弃路由的步骤组成。 这些步骤称为修剪规则。 通常，当算法终止时，集合中只剩下一条路由。 如果集合变空，则数据包将被丢弃，因为目的地无法到达。 当集合中保留多于一条路由时，算法也可能终止。 在这种情况下，路由器可以任意丢弃除其中一个以外的所有路由，或者可以通过选择最近最少使用的路由来执行“负载分配”。

除了规则 3（弱 TOS）之外，路由器在为数据包选择下一跳时必须使用以下修剪规则。 如果路由器在做出下一跳决策时确实考虑 TOS，则必须按下面所示的顺序应用规则 3。 这些规则必须（概念上）按照它们出现的顺序应用于 FIB。  （有关一些历史观点、附加修剪规则和其他常用算法，请参阅附录 E。）

讨论 规则 3 是可选的，[5.3.2] 节规定路由器在做出转发决策时只应该考虑 TOS。  (1) 基本匹配 该规则丢弃除数据包的 IP 目标地址之外的任何目的地的路由。 例如，如果数据包的 IP 目标地址是 10.144.2.5，则此步骤将丢弃到网络 128.12.0.0/16 的路由，但会保留到网络前缀 10.0.0.0/8 和 10.144.0.0/16 的所有路由，以及任何 默认路由。 更准确地说，我们假设每个路由都有一个目的地属性（称为route.dest）和相应的前缀长度（称为route.length），以指定route.dest的哪些位是重要的。 正在转发的数据包的 IP 目标地址是 ip.dest。 此规则丢弃候选集中的所有路由，除了那些route.dest 和ip.dest 的最高有效route.length 位相等的路由之外。 例如，如果数据包的 IP 目标地址为 10.144.2.5，并且存在网络前缀 10.144.1.0/24、10.144.2.0/24 和 10.144.3.0/24，则该规则将仅保留 10.144.2.0/24； 它是唯一一个其前缀与数据包的 IP 目标地址中的相应位具有相同值的路由。  (2) 最长匹配 如上所述，最长匹配是基本匹配的改进。 执行基本匹配修剪后，算法会检查剩余路由以确定其中哪些路由具有最大的route.length 值。 除了这些之外的所有内容都被丢弃。 例如，如果数据包的 IP 目标地址为 10.144.2.5，并且存在网络前缀 10.144.2.0/24、10.144.0.0/16 和 10.0.0.0/8，则此规则将仅保留第一个 (10.144.2.0/  24) 因为它的前缀长度最长。